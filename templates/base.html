<!DOCTYPE html>
<html>

    <head>
        <title>{% block title %}Bienvenue sur votre espace{% endblock %}</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/spinner.css' ) }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/card_spinner.css' ) }}">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
            integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
    </head>

    <body>
        <nav class="navbar navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="/"><i class="bi bi-house"></i></a>
                <a id="profBtn" class="navbar-brand ml-auto" href="/professor" aria-hidden="true" style="display: none;">Espace professeur</a>
                <a id="adminBtn" class="navbar-brand ml-auto" href="/admin" aria-hidden="true" style="display: none;">Espace admin</a>
                <a id="connexionBtn" class="navbar-brand ml-auto">Connexion</a>
               
                <div class="dropdown navbar-brand ml-auto">
                    <div class="nav-item dropdown">
                        <button class="btn dropdown-toggle" type="button" id="navbarDarkDropdownMenuLink" data-toggle="dropdown">
                            <img src="{{ url_for('static', filename='icons/profil.png' ) }}" alt="Info" style="width: 20px; height: 20px; cursor: pointer;">
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                            <li><a class="dropdown-item" data-toggle="modal" data-target="#userInfoModal"><i class="bi bi-person"></i> Mon compte</a></li>
                            <li><a class="dropdown-item" href="/dashboard"><i class="bi bi-box-arrow-right"></i> Dashboard</a></li>
                            <li><a class="dropdown-item" href="/professor"><i class="bi bi-box-arrow-right"></i> Espace professeur</a></li>
                            <li><a class="dropdown-item" href="/admin"><i class="bi bi-box-arrow-right"></i> Espace admin</a></li>
                            <li><a class="dropdown-item" onclick="logout()" href="#"><i class="bi bi-box-arrow-right"></i> Déconnexion</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- user info modal -->
        <div class="modal fade" id="userInfoModal" tabindex="-1" aria-labelledby="userInfoLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-dark text-white">
                        <h1 class="modal-title" id="exampleModalToggleLabel2">Mon compte</h1>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>    
                        </button>
                    </div>
                    <div class="modal-body bg-dark text-white">
                        <p id="tt-email">Email: </p>
                        <p id="tt-name">Name: </p>
                        <p id="tt-surname">Surname: </p>
                        <p id="tt-role">Role: </p>
                        <p id="tt-id">ID: </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading modal -->
        <div class="modal" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="loadingModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                            <div class="lds-spinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                        </div>
                        <p class="mt-2">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="alertModal" tabindex="-1" role="dialog" aria-labelledby="alertModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="alertModalLabel"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="alertModalMessage"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
            function checkIfVmAliveAdmin(vmId) {
                return new Promise(function (resolve, reject) {
                    showLoadingCardModal(vmId);   
                    $.ajax({
                        type: 'GET',
                        url: 'https://api.insa-cvl.com/vm/status/id/' + vmId,
                        contentType: 'application/json;charset=UTF-8',
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function (response) {
                            if (response.vm_state == "1" && response.status == "ACTIVE") {
                                hideLoadingCardModal(vmId);
                                resolve(1); 
                            } else {
                                hideLoadingCardModal(vmId);
                                resolve(0);
                            }
                        },
                        error: function (error) {
                            reject("Erreur d'obtention d'informations de la VM");
                        }
                    });
                });
            }

            function showLoadingCardModal(id) {
                $("#" + id + "-loading-modal").css("display", "block");
            }

            function hideLoadingCardModal(id) {
                $("#" + id + "-loading-modal").css("display", "none");
            }

            function createLdsDefaultContainer(id) {
                var ldsDefaultContainer = $('<div>').addClass('lds-default-container');
                var ldsDefaultSpinner = createLdsDefaultSpinner(id);
                ldsDefaultContainer.append(ldsDefaultSpinner);
                return ldsDefaultContainer;
            }

            function createLdsDefaultSpinner(id) {
                var ldsDefaultSpinner = $('<div>')
                .addClass('lds-default')
                .attr('id', id + '-loading-modal')
                .css('display', 'none');            
                for (var i = 0; i < 12; i++) {
                    var childDiv = $('<div>');
                    ldsDefaultSpinner.append(childDiv);
                }
                return ldsDefaultSpinner;
            }

            function checkIfVmAlive(id) {
                return new Promise(function (resolve, reject) {
                    showLoadingCardModal(id);   
                    $.ajax({
                        type: 'GET',
                        url: 'https://api.insa-cvl.com/vm/status/template/' + id,
                        contentType: 'application/json;charset=UTF-8',
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function (response) {
                            if (response.vm_state == "1" && response.status == "ACTIVE") {
                                hideLoadingCardModal(id);
                                resolve(1); 
                            } else {
                                hideLoadingCardModal(id);
                                resolve(0);
                            }
                        },
                        error: function (error) {
                            reject("Erreur d'obtention d'informations de la VM");
                        }
                    });
                });
            }

            function showLoadingModal() {
                $('#loadingModal').modal('show');
            }

            function hideLoadingModal() {
                $('#loadingModal').modal('hide');
            }

            function showAlertModal(title, message) {
                var modalTitle = document.getElementById('alertModalLabel');
                var modalMessage = document.getElementById('alertModalMessage');

                modalTitle.textContent = title;
                modalMessage.textContent = message;

                var alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
                alertModal.show();
            }

            function logout() {
                $.ajax({
                    type: 'GET',
                    url: 'https://api.insa-cvl.com/logout',
                    contentType: 'application/json;charset=UTF-8',
                    xhrFields: {
                        withCredentials: true
                    },
                    success: function (response) {
                        if (response.cas === true) {
                            window.location = "https://cas.insa-cvl.fr/cas/logout?service=https://api.insa-cvl.com"
                        } 
                        setTimeout(function () {
                                window.location = "/login?success=" + encodeURIComponent("Déconnecté avec succès");
  
                        }, 1000);
                    },
                    error: function (error) {
                        alert('Erreur lors de la déconnexion');
                    }
                });
            }


            function redirectToLogin() {
                window.location.href = '/login';
            }

            function updateConnectionStatus(isConnected) {
                if (isConnected) {
                    $('#connexionBtn').hide();
                    $('#userInfo').show();
                } else {
                    $('#connexionBtn').show();
                    $('#userInfo').hide();
                }
            }

            function getUserProfile() {
                $.ajax({
                    type: 'GET',
                    url: 'https://api.insa-cvl.com/profile',
                    contentType: 'application/json;charset=UTF-8',
                    xhrFields: {
                        withCredentials: true
                    },
                    success: function (response) {
                        var user = response;
                        $('#tt-email').text('Email: ' + user.email);
                        $('#tt-name').text('Name: ' + user.first_name);
                        $('#tt-surname').text('Surname: ' + user.last_name);
                        $('#tt-role').text('Role: ' + user.role);
                        $('#tt-id').text('ID: ' + user.id);

                        var userRole = user.role;
                        if (userRole === 'prof') {
                            $('#profBtn').show();
                        }
                        if (userRole === 'admin') {
                            $('#adminBtn').show();
                        }
                        updateConnectionStatus(true);
                    },
                    error: function (error) {
                        updateConnectionStatus(false);
                        window.location = "/login?error=" + encodeURIComponent('Vous%20n\'êtes%20pas%20connecté.%20Redirection....');
                    }
                });
            }

            function getTemplates() {
                $.ajax({
                    type: 'GET',
                    url: 'https://api.insa-cvl.com/template',
                    contentType: 'application/json;charset=UTF-8',
                    xhrFields: {
                        withCredentials: true
                    },
                    success: function (response) {
                        var templates = response;
                        templatesDiv = $('#templates-div');
                        templates.forEach(addTemplateToDOM);
                    },
                    error: function (error) {
                        alert('Erreur d\'obtention d\'informations de templates');
                    }
                });
            }
            $(document).ready(function () {
                getUserProfile();
            });
        </script>

        <style>
            .lds-default-container {
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .cards {
                display: flex;
                flex-wrap: wrap;
                list-style: none;
                padding: 0;
                margin: 20px;
            }

            .card {
                width: 18rem;
                margin: 10px;
            }

            body {
                background-color: #333;
                color: white;
            }

            h1 {
                margin: 20px;
                font-size: 24px;
                text-align: center;
            }

            h2 {
                font-size: 20px;
                text-align: center;
            }

            #addTemplateCard {
                cursor: pointer;
            }

            #addUserCard, #addVMOutCard {
                cursor: pointer;
            }

            .navbar {
                background-color: #343A40;
            }

            .navbar-dark .navbar-nav .nav-link {
                color: white;
            }

            .navbar-dark .navbar-nav .nav-link:hover {
                color: #17A2B8;
            }

            .nav-item {
                padding: 0 20px;
            }

            a {
                color: inherit;
            }

            a:hover {
                cursor: pointer;
            }
        </style>    
        {% block content %}{% endblock %}
    </body>
</html>